name: ci

permissions:
  contents: read
  pull-requests: read
  actions: read

env:
  VERSION: "${{ github.ref_name }}"

on:
  workflow_dispatch: { }
  push:
    tags:
      - "v*.*.*"
    branches:
      - main
    paths-ignore:
      - "docs/**"
      - "**.md"
      - "**.mdx"
      - "**.png"
      - "**.jpg"
  pull_request:
    branches:
      - main
    paths-ignore:
      - "docs/**"
      - "**.md"
      - "**.mdx"
      - "**.png"
      - "**.jpg"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref && github.ref || github.run_id }}
  cancel-in-progress: true


# Disable OpenMP,
# see https://github.com/ggerganov/llama.cpp/issues/7743#issuecomment-2148342691,
#     https://github.com/ggerganov/llama.cpp/issues/7719#issuecomment-2147631216.
jobs:
  
  darwin:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: "amd64"
            instruction: "avx2"
    runs-on: ${{ matrix.arch == 'amd64' && 'macos-13' || 'macos-14' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-darwin-${{ matrix.arch }}-${{ matrix.instruction }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Deps
        run: |
          brew update && brew install ccache
      - name: Setup XCode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
        run: |
          echo "===== BUILD ====="
          mkdir -p ${{ github.workspace }}/.cache
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_ACCELERATE=on -DGGML_METAL=off \
            -DGGML_NATIVE=off \
            ${{ matrix.instruction == 'avx2' && '-DGGML_AVX2=on' || '' }} \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)
          
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            otool -L ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi
          
          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-darwin-${{ matrix.arch }}-${{ matrix.instruction }}.zip ${{ github.workspace }}/build/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-darwin-${{ matrix.arch }}-${{ matrix.instruction }}

  darwin-metal:
    strategy:
      fail-fast: false
      matrix:
        arch: [ amd64, arm64 ]
        version: [ '3.0' ]
    # see https://github.com/actions/runner-images?tab=readme-ov-file#available-images,
    #     https://support.apple.com/en-us/102894.
    runs-on: ${{ matrix.arch == 'amd64' && 'macos-13' || 'macos-14' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-darwin-metal-${{ matrix.arch }}-${{ matrix.version }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Deps
        run: |
          brew update && brew install ccache
      - name: Setup XCode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
        run: |
          echo "===== BUILD ====="
          mkdir -p ${{ github.workspace }}/.cache
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_ACCELERATE=on -DGGML_METAL=on -DGGML_METAL_EMBED_LIBRARY=on \
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)

          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            otool -L ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi

          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-darwin-${{ matrix.arch }}-metal.zip ${{ github.workspace }}/build/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-darwin-${{ matrix.arch }}-metal-${{ matrix.version }}

  linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: 'amd64'
            instruction: 'avx2'
          - arch: 'arm64'
            instruction: 'neon'
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize Docker Build Space
        uses: gpustack/llama-box/.github/actions/maximize-docker-build-space@main
        with:
          deep-clean: false
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-linux-${{ matrix.arch }}-${{ matrix.instruction }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Setup QEMU
        if: ${{ matrix.arch == 'arm64' }}
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0
          platforms: "arm64"
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
        run: |
          echo "===== SCRIPT ====="
          cat <<EOF > /tmp/entrypoint.sh
          #!/bin/bash
          apt-get update && apt-get install -y binutils pkg-config build-essential git cmake ccache libopenblas-dev
          git config --system --add safe.directory '*'
          mkdir -p ${{ github.workspace }}/.cache
          echo "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_NATIVE=off \
            ${{ matrix.instruction == 'avx2' && '-DGGML_AVX2=on' || '' }} \
            -DGGML_BLAS_VENDOR=OpenBLAS \
            -DGGML_STATIC=on \
            -DGGML_BLAS=on \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            ldd ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi
          EOF
          chmod +x /tmp/entrypoint.sh
          cat /tmp/entrypoint.sh

          docker run \
            --rm \
            --privileged \
            --platform linux/${{ matrix.arch }} \
            --volume ${{ github.workspace }}:${{ github.workspace }} \
            --workdir ${{ github.workspace }} \
            --env CCACHE_DIR \
            --env VERSION \
            --volume /tmp/entrypoint.sh:/entrypoint.sh \
            --entrypoint /entrypoint.sh \
            ubuntu:22.04

          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-linux-${{ matrix.arch }}-${{ matrix.instruction }}.zip ${{ github.workspace }}/build/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-linux-${{ matrix.arch }}-${{ matrix.instruction }}

  linux-hip:
    strategy:
      fail-fast: false
      matrix:
        # see https://hub.docker.com/r/rocm/dev-ubuntu-22.04/tags.
        #     6.2 ==> 6.2.0
        #     6.1 ==> 6.1.2
        # build fat binary,
        # see https://github.com/ggerganov/llama.cpp/pull/1087#issuecomment-1682807878,
        #     https://llvm.org/docs/AMDGPUUsage.html.
        # official gpu support list,
        # see https://rocm.docs.amd.com/projects/install-on-linux/en/docs-6.2.0/reference/system-requirements.html,
        #     https://rocm.docs.amd.com/projects/install-on-linux/en/docs-6.1.2/reference/system-requirements.html.
        arch: [ amd64 ]
        version: [ '6.2', '6.1' ]
        size: [ 's', 'l' ]
        exclude:
          - size: 'l'
            version: '6.1'
        include:
          - size: 's'
            hip_arch: 'gfx1030;gfx1100;gfx1101;gfx1102'
          - size: 'l'
            hip_arch: 'gfx900;gfx906;gfx908;gfx90a;gfx940;gfx942;gfx1030;gfx1100;gfx1101;gfx1102'
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize Docker Build Space
        uses: gpustack/llama-box/.github/actions/maximize-docker-build-space@main
        with:
          deep-clean: false
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-linux-hip-${{ matrix.arch }}-${{ matrix.version }}-${{ matrix.size }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Setup QEMU
        if: ${{ matrix.arch == 'arm64' }}
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0
          platforms: "arm64"
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
          AMDGPU_TARGETS: "${{ matrix.hip_arch }}"
        run: |
          echo "===== SCRIPT ====="
          cat <<EOF > /tmp/entrypoint.sh
          #!/bin/bash
          apt-get update && apt-get install -y build-essential git cmake ccache
          git config --system --add safe.directory '*'
          mkdir -p ${{ github.workspace }}/.cache
          echo "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_HIPBLAS=on -DAMDGPU_TARGETS="${AMDGPU_TARGETS}" \
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            ldd ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi
          EOF
          chmod +x /tmp/entrypoint.sh
          cat /tmp/entrypoint.sh

          docker run \
            --rm \
            --privileged \
            --platform linux/${{ matrix.arch }} \
            --volume ${{ github.workspace }}:${{ github.workspace }} \
            --workdir ${{ github.workspace }} \
            --env CC=/opt/rocm/llvm/bin/clang \
            --env CXX=/opt/rocm/llvm/bin/clang++ \
            --env CCACHE_DIR \
            --env AMDGPU_TARGETS \
            --env VERSION \
            --volume /tmp/entrypoint.sh:/entrypoint.sh \
            --entrypoint /entrypoint.sh \
            rocm/dev-ubuntu-22.04:${{ matrix.version == '6.2' && '6.2' || '6.1.2' }}-complete

          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-linux-${{ matrix.arch }}-hip-${{ matrix.version }}-${{ matrix.size }}.zip ${{ github.workspace }}/build/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-linux-${{ matrix.arch }}-hip-${{ matrix.version }}-${{ matrix.size }}

  linux-cuda:
    strategy:
      fail-fast: false
      matrix:
        # see https://hub.docker.com/r/nvidia/cuda/tags?page=&page_size=&ordering=&name=devel.
        #     12.6 ==> 12.6.1
        #     11.8 ==> 11.8.0
        # build fat binary,
        # see https://developer.nvidia.com/cuda-gpus.
        arch: [ amd64 ]
        version: [ '12.6', '11.8' ]
        size: [ 's', 'l' ]
        exclude:
          - size: 'l'
            version: '11.8'
        include:
          - size: 's'
            cuda_arch: '80-real;86-real;89'
          - size: 'l'
            cuda_arch: '60-real;61-real;70-real;75-real;80-real;86-real;89'
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize Docker Build Space
        uses: gpustack/llama-box/.github/actions/maximize-docker-build-space@main
        with:
          deep-clean: false
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-linux-cuda-${{ matrix.arch }}-${{ matrix.version }}-${{ matrix.size }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Setup QEMU
        if: ${{ matrix.arch == 'arm64' }}
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0
          platforms: "arm64"
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
          CUDA_ARCHITECTURES: "${{ matrix.cuda_arch }}"
        run: |
          echo "===== SCRIPT ====="
          cat <<EOF > /tmp/entrypoint.sh
          #!/bin/bash
          apt-get update && apt-get install -y build-essential git cmake ccache
          git config --system --add safe.directory '*'
          mkdir -p ${{ github.workspace }}/.cache
          ## dynamic
          echo "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_CUDA=on -DCMAKE_CUDA_ARCHITECTURES="${CUDA_ARCHITECTURES}" \
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            ldd ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi
          ## static
          echo "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build-static -DCMAKE_BUILD_TYPE=Release \
            -DGGML_CUDA=on -DCMAKE_CUDA_ARCHITECTURES="${CUDA_ARCHITECTURES}" \
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} \
            -DGGML_STATIC=on \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build-static --target llama-box --config Release -- -j $(nproc)
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build-static/bin/llama-box ]; then
            ldd ${{ github.workspace }}/build-static/bin/llama-box
          else
            exit 1
          fi
          EOF
          chmod +x /tmp/entrypoint.sh
          cat /tmp/entrypoint.sh

          docker run \
            --rm \
            --privileged \
            --platform linux/${{ matrix.arch }} \
            --volume ${{ github.workspace }}:${{ github.workspace }} \
            --workdir ${{ github.workspace }} \
            --env CCACHE_DIR \
            --env CUDA_ARCHITECTURES \
            --env VERSION \
            --volume /tmp/entrypoint.sh:/entrypoint.sh \
            --entrypoint /entrypoint.sh \
            nvidia/cuda:${{ matrix.version == '12.6' && '12.6.1' || '11.8.0' }}-devel-ubuntu22.04

          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-linux-${{ matrix.arch }}-cuda-${{ matrix.version }}-${{ matrix.size }}.zip ${{ github.workspace }}/build/bin/*
          zip -j ${{ github.workspace }}/out/llama-box-linux-${{ matrix.arch }}-cuda-${{ matrix.version }}-${{ matrix.size }}-static.zip ${{ github.workspace }}/build-static/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-linux-${{ matrix.arch }}-cuda-${{ matrix.version }}-${{ matrix.size }}

  linux-oneapi:
    strategy:
      fail-fast: false
      matrix:
        # see https://hub.docker.com/r/intel/oneapi-basekit/tags?page=&page_size=&ordering=&name=devel.
        #     2024.2 ==> 2024.2.0
        #     2024.1 ==> 2024.1.1
        arch: [ amd64 ]
        version: [ '2024.2', '2024.1' ]
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize Docker Build Space
        uses: gpustack/llama-box/.github/actions/maximize-docker-build-space@main
        with:
          deep-clean: false
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-linux-oneapi-${{ matrix.arch }}-${{ matrix.version }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Setup QEMU
        if: ${{ matrix.arch == 'arm64' }}
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0
          platforms: "arm64"
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
        run: |
          echo "===== SCRIPT ====="
          cat <<EOF > /tmp/entrypoint.sh
          #!/bin/bash
          apt-get update && apt-get install -y build-essential git cmake ccache
          git config --system --add safe.directory '*'
          mkdir -p ${{ github.workspace }}/.cache
          echo "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_SYCL=on -DGGML_SYCL_F16=on \
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            ldd ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi
          EOF
          chmod +x /tmp/entrypoint.sh
          cat /tmp/entrypoint.sh

          docker run \
            --rm \
            --privileged \
            --platform linux/${{ matrix.arch }} \
            --volume ${{ github.workspace }}:${{ github.workspace }} \
            --workdir ${{ github.workspace }} \
            --env CC=icx \
            --env CXX=icpx \
            --env CCACHE_DIR \
            --env VERSION \
            --volume /tmp/entrypoint.sh:/entrypoint.sh \
            --entrypoint /entrypoint.sh \
            intel/oneapi-basekit:${{ matrix.version == '2024.2' && '2024.2.0' || '2024.1.1' }}-devel-ubuntu22.04

          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-linux-${{ matrix.arch }}-oneapi-${{ matrix.version }}.zip ${{ github.workspace }}/build/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-linux-${{ matrix.arch }}-oneapi-${{ matrix.version }}

  linux-cann:
    strategy:
      fail-fast: false
      matrix:
        # see https://hub.docker.com/r/ascendai/cann/tags?page=&page_size=&ordering=&name=.
        #     8.0 ==> 8.0.RC1
        arch: [ amd64, arm64 ]
        version: [ '8.0' ]
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize Docker Build Space
        uses: gpustack/llama-box/.github/actions/maximize-docker-build-space@main
        with:
          deep-clean: false
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-linux-cann-${{ matrix.arch }}-${{ matrix.version }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Setup QEMU
        if: ${{ matrix.arch == 'arm64' }}
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0
          platforms: "arm64"
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
        run: |
          echo "===== SCRIPT ====="
          cat <<EOF > /tmp/entrypoint.sh
          #!/bin/bash
          source /usr/local/Ascend/ascend-toolkit/set_env.sh
          apt-get update && apt-get install -y build-essential git cmake ccache
          git config --system --add safe.directory '*'
          mkdir -p ${{ github.workspace }}/.cache
          echo "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_CANN=on \
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            ldd ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi
          EOF
          chmod +x /tmp/entrypoint.sh
          cat /tmp/entrypoint.sh

          docker run \
            --rm \
            --privileged \
            --platform linux/${{ matrix.arch }} \
            --volume ${{ github.workspace }}:${{ github.workspace }} \
            --workdir ${{ github.workspace }} \
            --env CCACHE_DIR \
            --env VERSION \
            --volume /tmp/entrypoint.sh:/entrypoint.sh \
            --entrypoint /entrypoint.sh \
            ascendai/cann:${{ matrix.version }}

          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-linux-${{ matrix.arch }}-cann-${{ matrix.version }}.zip ${{ github.workspace }}/build/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-linux-${{ matrix.arch }}-cann-${{ matrix.version }}

  linux-musa:
    strategy:
      fail-fast: false
      matrix:
        arch: [ amd64 ]
        version: [ '1.5' ]
    runs-on: ubuntu-22.04
    steps:
      - name: Maximize Docker Build Space
        uses: gpustack/llama-box/.github/actions/maximize-docker-build-space@main
        with:
          deep-clean: false
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-linux-musa-${{ matrix.arch }}-${{ matrix.version }}
          path: |
            ${{ github.workspace }}/.cache
      - name: Setup QEMU
        if: ${{ matrix.arch == 'arm64' }}
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0
          platforms: "arm64"
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}/.cache/ccache"
          CMAKE_VERSION: "3.22.1"
        run: |
          echo "===== SCRIPT ====="
          cat <<EOF > /tmp/entrypoint.sh
          #!/bin/bash
          apt-get update && apt-get install -y ccache curl git
          git config --system --add safe.directory '*'
          curl -s -L https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-$(uname -m).tar.gz | tar -zx -C /usr --strip-components 1
          mkdir -p ${{ github.workspace }}/.cache
          echo "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release \
            -DGGML_MUSA=on \
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} \
            -DGGML_OPENMP=off \
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}/build --target llama-box --config Release -- -j $(nproc)
          echo "===== RESULT ====="
          if [ -f ${{ github.workspace }}/build/bin/llama-box ]; then
            ldd ${{ github.workspace }}/build/bin/llama-box
          else
            exit 1
          fi
          EOF
          chmod +x /tmp/entrypoint.sh
          cat /tmp/entrypoint.sh

          docker run \
            --rm \
            --privileged \
            --platform linux/${{ matrix.arch }} \
            --volume ${{ github.workspace }}:${{ github.workspace }} \
            --workdir ${{ github.workspace }} \
            --env CCACHE_DIR \
            --env VERSION \
            --volume /tmp/entrypoint.sh:/entrypoint.sh \
            --entrypoint /entrypoint.sh \
            mthreads/musa:${{ matrix.version == '1.5' && '1.5.1-mp_22' }}-devel-ubuntu20.04

          echo "===== PACKAGE ====="
          mkdir -p ${{ github.workspace }}/out
          zip -j ${{ github.workspace }}/out/llama-box-linux-${{ matrix.arch }}-musa-${{ matrix.version }}.zip ${{ github.workspace }}/build/bin/*
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}/out/*.zip
          name: llama-box-linux-${{ matrix.arch }}-musa-${{ matrix.version }}

  windows:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: 'amd64'
            instruction: 'avx2'
          - arch: 'arm64'
            instruction: 'neon'
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          key: cache-windows-${{ matrix.arch }}-${{ matrix.instruction }}
          path: |
            ${{ github.workspace }}\build
      - name: Build
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'
          
          Write-Host "===== BUILD ====="
          New-Item -Force -ItemType Directory -Path "${{ github.workspace }}\.cache" -ErrorAction Ignore | Out-Null
          cmake ${{ matrix.arch == 'arm64' && format('-D CMAKE_TOOLCHAIN_FILE={0}\llama-box\scripts\build-windows-neon.cmake', github.workspace) || '' }} -S ${{ github.workspace }} -B ${{ github.workspace }}\build -DCMAKE_BUILD_TYPE=Release `
            -DGGML_NATIVE=off `
            ${{ matrix.instruction == 'avx2' && '-DGGML_AVX2=on' || '' }} `
            -DGGML_STATIC=on `
            -DGGML_OPENMP=off `
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}\build --target llama-box --config Release -- /m:${env:NUMBER_OF_PROCESSORS}
          Write-Host "===== RESULT ====="
          if (Test-Path -Path "${{ github.workspace }}\build\bin\Release\llama-box.exe") {
            llvm-objdump.exe -p "${{ github.workspace }}\build\bin\Release\llama-box.exe"
          } else {
            exit 1
          }
          
          Write-Host "===== PACKAGE ====="
          New-Item -Force -ItemType Directory -Path "${{ github.workspace }}\out" -ErrorAction Ignore | Out-Null
          Compress-Archive -Path "${{ github.workspace }}\build\bin\Release\*" -DestinationPath "${{ github.workspace }}\out\llama-box-windows-${{ matrix.arch }}-${{ matrix.instruction }}.zip"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}\\out\\*.zip
          name: llama-box-windows-${{ matrix.arch }}-${{ matrix.instruction }}

  windows-hip:
    strategy:
      fail-fast: false
      matrix:
        # see https://www.amd.com/en/developer/resources/rocm-hub/hip-sdk.html.
        #     6.1 ==> 6.1.2
        #     5.7 ==> 5.7.1
        # build fat binary,
        # see https://github.com/ggerganov/llama.cpp/pull/1087#issuecomment-1682807878,
        #     https://llvm.org/docs/AMDGPUUsage.html.
        # official gpu support list,
        # see https://rocm.docs.amd.com/projects/install-on-linux/en/docs-6.1.2/reference/system-requirements.html,
        #     https://rocm.docs.amd.com/en/docs-5.7.1/release/windows_support.html.
        arch: [ amd64 ]
        version: [ '6.1', '5.7' ]
        size: [ 's', 'l' ]
        exclude:
          # NB(thxCode): https://github.com/ggerganov/llama.cpp/pull/8713#issuecomment-2331104373 has broken the compiling
          #  of ROCm/HIP 5.7, we have temporarily stopped supplying new versions from ROCm/HIP 5.7 until upstream fixes it.
          - version: '5.7'
        include:
          - size: 's'
            hip_arch: 'gfx1030;gfx1100;gfx1101;gfx1102'
          - size: 'l'
            hip_arch: 'gfx900;gfx906;gfx908;gfx90a;gfx940;gfx942;gfx1030;gfx1100;gfx1101;gfx1102'
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          save-always: true
          key: cache-windows-hip-${{ matrix.arch }}-${{ matrix.version }}-${{ matrix.size }}
          path: |
            ${{ github.workspace }}\.cache
      - name: Deps
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'

          choco install ccache curl -y
      - name: Setup HIP
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'

          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] download AMD ROCm HIP SDK"
          curl.exe --retry 5 --retry-delay 5 `
            --output "${{ runner.temp }}\installer.exe" `
            --url "https://download.amd.com/developer/eula/rocm-hub/AMD-Software-PRO-Edition-${{ matrix.version == '6.1' && '24.Q3' || '23.Q4' }}-WinSvr2022-For-HIP.exe"
          
          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] install AMD ROCm HIP SDK"
          Start-Process "${{ runner.temp }}\installer.exe" -NoNewWindow -Wait `
            -ArgumentList '-install'

          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] verify AMD ROCm HIP SDK"
          & 'C:\Program Files\AMD\ROCm\*\bin\clang.exe' --version

          $hipPath = "$(Resolve-Path -Path 'C:\Program Files\AMD\ROCm\*\bin\clang.exe' | Split-Path | Split-Path)"
          "HIP_PATH=${hipPath}" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Build
        env:
          CCACHE_DIR: "${{ github.workspace }}\\.cache\\ccache"
          AMDGPU_TARGETS: "${{ matrix.hip_arch }}"
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'
          
          Write-Host "HIP_PATH=${env:HIP_PATH}"
          
          Write-Host "===== BUILD ====="
          New-Item -Force -ItemType Directory -Path "${{ github.workspace }}\.cache" -ErrorAction Ignore | Out-Null
          $env:CMAKE_PREFIX_PATH = "${env:HIP_PATH}"
          cmake -G "Unix Makefiles" -S ${{ github.workspace }} -B ${{ github.workspace }}\build -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_C_COMPILER="${env:HIP_PATH}\bin\clang.exe" -DCMAKE_CXX_COMPILER="${env:HIP_PATH}\bin\clang++.exe" `
            -DGGML_HIPBLAS=on -DAMDGPU_TARGETS="${env:AMDGPU_TARGETS}" `
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} `
            -DGGML_OPENMP=off `
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}\build --target llama-box --config Release -- -j ${env:NUMBER_OF_PROCESSORS}
          Write-Host "===== RESULT ====="
          if (Test-Path -Path "${{ github.workspace }}\build\bin\llama-box.exe") {
            llvm-objdump.exe -p "${{ github.workspace }}\build\bin\llama-box.exe"
          } else {
            exit 1
          }

          Write-Host "===== PACKAGE ====="
          New-Item -Force -ItemType Directory -Path "${{ github.workspace }}\out" -ErrorAction Ignore | Out-Null
          Compress-Archive -Path "${{ github.workspace }}\build\bin\*" -DestinationPath "${{ github.workspace }}\out\llama-box-windows-${{ matrix.arch }}-hip-${{ matrix.version }}-${{ matrix.size }}.zip"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}\\out\\*.zip
          name: llama-box-windows-${{ matrix.arch }}-hip-${{ matrix.version }}-${{ matrix.size }}

  windows-cuda:
    strategy:
      fail-fast: false
      matrix:
        # see https://developer.nvidia.com/cuda-downloads?target_os=Windows&target_arch=x86_64&target_version=Server2022&target_type=exe_network.
        #     12.6 ==> 12.6.1
        #     11.8 ==> 11.8.0
        # build fat binary,
        # see https://developer.nvidia.com/cuda-gpus.
        arch: [ amd64 ]
        version: [ '12.6', '11.8' ]
        size: [ 's', 'l' ]
        exclude:
          - size: 'l'
            version: '11.8'
        include:
          - size: 's'
            cuda_arch: '80-real;86-real;89'
          - size: 'l'
            cuda_arch: '60-real;61-real;70-real;75-real;80-real;86-real;89'
    # see https://github.com/actions/runner-images?tab=readme-ov-file#available-images,
    #     https://forums.developer.nvidia.com/t/problems-with-latest-vs2022-update/294150.
    runs-on: ${{ matrix.version == '12.6' && 'windows-2022' || 'windows-2019' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        # doesn't support ccache,
        # see https://stackoverflow.com/questions/72829476/how-to-use-ccache-4-6-1-on-windows-msvc-with-cmake.
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          key: cache-windows-cuda-${{ matrix.arch }}-${{ matrix.version }}-${{ matrix.size }}
          path: |
            ${{ github.workspace }}\build
            ${{ github.workspace }}\build-static
      - name: Deps
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'

          choco install curl -y
      - name: Setup CUDA
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'
          
          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] download NVIDIA CUDA SDK"
          $CUDA_VERSION = "${{ matrix.version == '12.6' && '12.6.1' || '11.8.0' }}"
          curl.exe --retry 5 --retry-delay 5 `
            --output "${{ runner.temp }}\installer.exe" `
            --url "https://developer.download.nvidia.com/compute/cuda/${CUDA_VERSION}/network_installers/cuda_${CUDA_VERSION}_windows_network.exe"
          
          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] install NVIDIA CUDA SDK"
          Start-Process "${{ runner.temp }}\installer.exe" -NoNewWindow -Wait `
            -ArgumentList '-s','nvcc_${{ matrix.version }}','cudart_${{ matrix.version }}','cublas_${{ matrix.version }}','cublas_dev_${{ matrix.version }}','thrust_${{ matrix.version }}','visual_studio_integration_${{ matrix.version }}'
          
          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] verify NVIDIA CUDA SDK"
          & 'C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v*\bin\nvcc.exe' --version
          
          $cudaPath = "$(Resolve-Path -Path 'C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v*\bin\nvcc.exe' | Split-Path | Split-Path)"
          $cudaVersion=($cudaPath | Split-Path -Leaf ) -replace 'v(\d+).(\d+)', '$1_$2' 
          "CUDA_PATH=${cudaPath}" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CUDA_PATH_V${cudaVersion}=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CUDA_PATH_VX_Y=CUDA_PATH_V${cudaVersion}" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Build
        env:
          CUDA_ARCHITECTURES: "${{ matrix.cuda_arch }}"
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'

          Write-Host "CUDA_PATH=${env:CUDA_PATH}"

          ## dynamic
          Write-Host "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}\build -DCMAKE_BUILD_TYPE=Release `
            -DGGML_CUDA=on -DCMAKE_CUDA_ARCHITECTURES="${env:CUDA_ARCHITECTURES}" `
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} `
            -DGGML_OPENMP=off `
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}\build --target ggml --config Release -- /m:$((${env:NUMBER_OF_PROCESSORS} - 1))
          cmake --build ${{ github.workspace }}\build --target llama-box --config Release -- /m:${env:NUMBER_OF_PROCESSORS}
          Write-Host "===== RESULT ====="
          if (Test-Path -Path "${{ github.workspace }}\build\bin\Release\llama-box.exe") {
            llvm-objdump.exe -p "${{ github.workspace }}\build\bin\Release\llama-box.exe"
          } else {
              exit 1
          }
          
          ## static
          Write-Host "===== BUILD ====="
          cmake -S ${{ github.workspace }} -B ${{ github.workspace }}\build-static -DCMAKE_BUILD_TYPE=Release `
            -DGGML_CUDA=on -DCMAKE_CUDA_ARCHITECTURES="${env:CUDA_ARCHITECTURES}" `
            ${{ matrix.arch == 'amd64' && '-DGGML_NATIVE=off' || '-DGGML_NATIVE=on' }} `
            -DGGML_OPENMP=off `
            -DGGML_RPC=on
          cmake --build ${{ github.workspace }}\build-static --target ggml --config Release -- /m:$((${env:NUMBER_OF_PROCESSORS} - 1))
          cmake --build ${{ github.workspace }}\build-static --target llama-box --config Release -- /m:${env:NUMBER_OF_PROCESSORS}
          Write-Host "===== RESULT ====="
          if (Test-Path -Path "${{ github.workspace }}\build-static\bin\Release\llama-box.exe") {
            llvm-objdump.exe -p "${{ github.workspace }}\build-static\bin\Release\llama-box.exe"
          } else {
              exit 1
          }

          Write-Host "===== PACKAGE ====="
          New-Item -Force -ItemType Directory -Path "${{ github.workspace }}\out" -ErrorAction Ignore | Out-Null
          Compress-Archive -Path "${{ github.workspace }}\build\bin\Release\*" -DestinationPath "${{ github.workspace }}\out\llama-box-windows-${{ matrix.arch }}-cuda-${{ matrix.version }}-${{ matrix.size }}.zip"
          Compress-Archive -Path "${{ github.workspace }}\build-static\bin\Release\*" -DestinationPath "${{ github.workspace }}\out\llama-box-windows-${{ matrix.arch }}-cuda-${{ matrix.version }}-${{ matrix.size }}-static.zip"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}\\out\\*.zip
          name: llama-box-windows-${{ matrix.arch }}-cuda-${{ matrix.version }}-${{ matrix.size }}

  windows-oneapi:
    strategy:
      fail-fast: false
      matrix:
        # see https://www.intel.com/content/www/us/en/developer/tools/oneapi/base-toolkit-download.html?operatingsystem=windows&windows-install-type=offline.
        #     2024.2 ==> 2024.2.0
        #     2024.1 ==> 2024.1.1
        arch: [ amd64 ]
        version: [ '2024.2', '2024.1' ]
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: Setup Cache
        # doesn't support ccache,
        # as the oneAPI need to configure the environment variables via setvars.bat.
        timeout-minutes: 5
        uses: actions/cache@v4
        with:
          key: cache-windows-oneapi-${{ matrix.arch }}-${{ matrix.version }}
          path: |
            ${{ github.workspace }}\build
      - name: Deps
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'

          choco install curl ninja -y
      - name: Setup oneAPI
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'

          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] download Intel oneAPI SDK"
          curl.exe --retry 5 --retry-delay 5 `
            --output "${{ runner.temp }}\installer.exe" `
            --url "https://registrationcenter-download.intel.com/akdlm/IRC_NAS/${{ matrix.version == '2024.2' && 'e83a8e64-04fc-45df-85c6-c2208d03bdb5/w_BaseKit_p_2024.2.0.635' || '7dff44ba-e3af-4448-841c-0d616c8da6e7/w_BaseKit_p_2024.1.0.595' }}.exe"
          
          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] install Intel oneAPI SDK"
          Start-Process "${{ runner.temp }}\installer.exe" -NoNewWindow -Wait `
            -ArgumentList '-s','--action=install','--components=intel.oneapi.win.cpp-dpcpp-common:intel.oneapi.win.mkl.devel','--eula=accept','-p=NEED_VS2017_INTEGRATION=0','-p=NEED_VS2019_INTEGRATION=0','-p=NEED_VS2022_INTEGRATION=0'

          Write-Host "I [$((Get-Date).ToString("yyyy-mm-dd HH:mm:ss"))] verify Intel oneAPI SDK"
          & 'C:\Program Files (x86)\Intel\oneAPI\*\bin\icx.exe' --version

          $oneapiPath = "$(Resolve-Path -Path 'C:\Program Files (x86)\Intel\oneAPI\*\bin\icx.exe' | Split-Path | Split-Path)"
          "ONEAPI_PATH=${oneapiPath}" | Out-File -FilePath $env:GITHUB_ENV -Append
          $oneapiRoot = "$(Split-Path -Path $oneapiPath)"
          "ONEAPI_ROOT=${oneapiRoot}" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Build
        run: |
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'
          
          Write-Host "ONEAPI_PATH=${env:ONEAPI_PATH}"
          Write-Host "ONEAPI_ROOT=${env:ONEAPI_ROOT}"
          
          Write-Host "===== BUILD ====="
          & "${{ github.workspace }}\llama-box\scripts\build-windows-oneapi.bat" "${{ github.workspace }}" "${{ matrix.arch }}"
          Write-Host "===== RESULT ====="
          if (Test-Path -Path "${{ github.workspace }}\build\bin\llama-box.exe") {
            llvm-objdump.exe -p "${{ github.workspace }}\build\bin\llama-box.exe"
          } else {
            exit 1
          }

          Write-Host "===== PACKAGE ====="
          New-Item -Force -ItemType Directory -Path "${{ github.workspace }}\out" -ErrorAction Ignore | Out-Null
          Compress-Archive -Path "${{ github.workspace }}\build\bin\*" -DestinationPath "${{ github.workspace }}\out\llama-box-windows-${{ matrix.arch }}-oneapi-${{ matrix.version }}.zip"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ github.workspace }}\\out\\*.zip
          name: llama-box-windows-${{ matrix.arch }}-oneapi-${{ matrix.version }}

  release:
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    permissions:
      contents: write
      actions: read
      id-token: write
    runs-on: ubuntu-22.04
    needs:
      - darwin
      - darwin-metal
      - linux
      - linux-hip
      - linux-cuda
      - linux-oneapi
      - linux-cann
      - linux-musa
      - windows
      - windows-hip
      - windows-cuda
      - windows-oneapi
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          path: ${{ github.workspace }}/out
          merge-multiple: true
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          fail_on_unmatched_files: true
          tag_name: "${{ env.VERSION }}"
          prerelease: ${{ contains(github.ref, 'rc') }}
          files: ${{ github.workspace }}/out/*
